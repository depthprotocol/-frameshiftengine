<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$DEPTH$ Protocol V1 (Integrity Firewall)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0d1117; 
            color: #e6edf3; 
            min-height: 100vh;
        }
        .card { 
            background-color: #161b22; 
            border: 1px solid #30363d; 
        }
        input, textarea, button { 
            transition: all 0.2s; 
            border: none;
        }
        /* Custom style for the countdown text */
        #next-mint-countdown {
            font-size: 1.125rem;
            font-weight: 700;
            color: #ffcc00; /* Amber/Yellow for attention */
            text-shadow: 0 0 5px rgba(255, 204, 0, 0.5);
        }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center justify-center">

    <div class="max-w-xl w-full">
        <!-- Configuration Warning REMOVED for clean demo -->
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-[#79e0ee] tracking-tight">$DEPTH$ Protocol V1</h1>
            <p class="text-sm text-gray-400 mt-1">The Frame Shift Engine: Proof of Growth (PoG)</p>
            <div id="auth-status" class="mt-4 text-xs font-medium px-3 py-1 rounded-full w-fit mx-auto shadow-inner bg-yellow-800 text-yellow-300">Authenticating...</div>
        </header>

        <!-- Metrics Dashboard -->
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div id="depth-tally" class="card p-4 rounded-xl shadow-lg text-center">
                <p class="text-xs text-gray-400 uppercase tracking-wider">Total D-PNT Minted</p>
                <p class="text-3xl font-bold mt-1 text-[#4d7d9a]"><span id="d-pnt-count">0</span> D-PNT</p>
            </div>
            <div id="streak-tracker" class="card p-4 rounded-xl shadow-lg text-center">
                <p class="text-xs text-gray-400 uppercase tracking-wider">Current Bloom Streak</p>
                <div class="flex flex-col items-center justify-center h-full -mt-2">
                    <p class="text-3xl font-bold text-[#79e0ee]"><span id="streak-count">0</span></p>
                    <p class="text-sm text-gray-400">/ 7 Days</p>
                    <div id="streak-progress" class="w-full h-2 rounded-full mt-2 bg-gray-700">
                        <div id="streak-bar" class="h-2 rounded-full bg-green-500 transition-all duration-500" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Frame Shift Input Form -->
        <div class="card p-6 rounded-xl shadow-2xl">
            <h2 class="text-xl font-semibold mb-4 text-[#79e0ee]">Log a Frame Shift (Daily Reward)</h2>
            <p class="text-sm text-gray-400 mb-4">Mint your D-PNT by recording a conscious choice.</p>
            
            <form id="frame-shift-form">
                <div class="mb-4">
                    <label for="trigger" class="block text-sm font-medium text-gray-300 mb-1">1. The Trigger (The Event)</label>
                    <textarea id="trigger" rows="2" class="w-full card p-3 rounded-lg border-none focus:ring-2 focus:ring-[#79e0ee] focus:border-transparent text-sm resize-none" placeholder="What happened? What was the external or internal event?" required></textarea>
                </div>
                <div class="mb-4">
                    <label for="old-frame" class="block text-sm font-medium text-gray-300 mb-1">2. The Old Frame (The Reactive Thought)</label>
                    <textarea id="old-frame" rows="2" class="w-full card p-3 rounded-lg border-none focus:ring-2 focus:ring-[#79e0ee] focus:border-transparent text-sm resize-none" placeholder="What was your initial, reactive, or negative thought/feeling?" required></textarea>
                </div>
                <div class="mb-6">
                    <label for="new-frame" class="block text-sm font-medium text-gray-300 mb-1">3. The New Frame (The Conscious Choice)</label>
                    <textarea id="new-frame" rows="3" class="w-full card p-3 rounded-lg border-none focus:ring-2 focus:ring-[#79e0ee] focus:border-transparent text-sm resize-none" placeholder="What is the conscious, productive frame you chose instead?" required></textarea>
                </div>
                
                <button type="submit" id="submit-button" class="w-full py-3 px-4 bg-[#79e0ee] text-black font-bold rounded-xl shadow-lg hover:bg-[#60b3c4] transition duration-200">
                    Mint D-PNT and Log Frame Shift
                </button>
            </form>
            <div id="message-container" class="mt-4 text-center text-sm">
                <p id="message-box"></p>
                <div id="countdown-display" class="pt-2 hidden">
                    <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Next D-PNT Mint Available In:</p>
                    <span id="next-mint-countdown">--:--:--</span>
                </div>
            </div>
        </div>

        <!-- Private History View -->
        <div class="mt-10">
            <h2 class="text-xl font-semibold mb-4 text-[#79e0ee] border-b border-gray-700 pb-2">Your Private History (Persistence)</h2>
            <p class="text-sm text-gray-400 mb-4">This ledger is for your eyes only. Use it to visibly measure your growth.</p>
            <div id="history-container" class="space-y-4">
                <p id="history-loading" class="text-gray-500 text-center">Loading past Frame Shifts...</p>
                <!-- History items will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, setDoc, collection, query, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================================
        // --- CONFIGURATION BLOCK FOR GITHUB / LOCAL HOSTING ---
        // These keys are only used if the app is run outside of the Canvas environment.
        const firebaseConfig = {
            apiKey: "AIzaSyBJbfi_BaUYd6nPlBHDdjbBm_RnPMIc4jM",
            authDomain: "depth-protocol.firebaseapp.com",
            projectId: "depth-protocol",
            storageBucket: "depth-protocol.firebasestorage.app",
            messagingSenderId: "376567424825",
            appId: "1:376567424825:web:a6752327fffe1fb57beae8",
            measurementId: "G-YWFQJCS9G7"
        };
        const LOCAL_APP_ID = "depth-protocol-github-default";
        // ====================================================================================

        setLogLevel('debug');

        let db, auth;
        let userId = null;
        let isAuthReady = false;
        let unsubscribeHistory = null;
        let countdownInterval = null; 

        const AUTH_STATUS = document.getElementById('auth-status');
        const MESSAGE_BOX = document.getElementById('message-box');
        const COUNTDOWN_DISPLAY = document.getElementById('countdown-display');
        const NEXT_MINT_COUNTDOWN = document.getElementById('next-mint-countdown');
        const DPNT_COUNT = document.getElementById('d-pnt-count');
        const STREAK_COUNT = document.getElementById('streak-count');
        const STREAK_BAR = document.getElementById('streak-bar');
        const HISTORY_CONTAINER = document.getElementById('history-container');
        const SUBMIT_BUTTON = document.getElementById('submit-button');

        // --- Determine Configuration Source (Canvas vs. Local/GitHub) ---
        let finalFirebaseConfig;
        let finalAppId;

        // Use Canvas globals if available, otherwise use hardcoded local config
        if (typeof __firebase_config !== 'undefined') {
            finalFirebaseConfig = JSON.parse(__firebase_config);
            finalAppId = typeof __app_id !== 'undefined' ? __app_id : LOCAL_APP_ID;
        } else {
            finalFirebaseConfig = firebaseConfig; 
            finalAppId = LOCAL_APP_ID;
            // Removed CONFIG_ALERT visual warning here
        }
        
        // --- Authentication Logic ---
        async function handleAuth() {
            try {
                AUTH_STATUS.textContent = 'Attempting Sign In...';
                AUTH_STATUS.classList.remove('bg-green-800', 'text-green-300', 'bg-red-800');
                AUTH_STATUS.classList.add('bg-yellow-800', 'text-yellow-300');

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                AUTH_STATUS.textContent = 'Authentication Failed';
                AUTH_STATUS.classList.remove('bg-yellow-800', 'text-yellow-300');
                AUTH_STATUS.classList.add('bg-red-800', 'text-red-300');
            }
        }

        async function initializeAppAndAuth() {
            // Basic check for local configuration integrity (if running locally)
            if (finalAppId === LOCAL_APP_ID && (!finalFirebaseConfig || !finalFirebaseConfig.apiKey || finalFirebaseConfig.apiKey === "YOUR_API_KEY_HERE")) {
                AUTH_STATUS.textContent = 'Configuration Error: Keys Missing';
                AUTH_STATUS.classList.remove('bg-yellow-800', 'text-yellow-300');
                AUTH_STATUS.classList.add('bg-red-800', 'text-red-300');
                return;
            }
            
            const app = initializeApp(finalFirebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    AUTH_STATUS.textContent = 'Authenticated: ' + userId.substring(0, 8) + '...';
                    AUTH_STATUS.classList.remove('bg-yellow-800', 'text-yellow-300', 'bg-red-800');
                    AUTH_STATUS.classList.add('bg-green-800', 'text-green-300');
                    isAuthReady = true;

                    // Unsubscribe previous listener and timer if they exist before setting up a new one
                    if (unsubscribeHistory) unsubscribeHistory();
                    if (countdownInterval) clearInterval(countdownInterval);
                    countdownInterval = null; 
                    
                    // Start the real-time listener for user history
                    unsubscribeHistory = setupHistoryListener();
                } else {
                    isAuthReady = false; 
                    AUTH_STATUS.textContent = 'Unauthenticated';
                    if (unsubscribeHistory) unsubscribeHistory();
                    if (countdownInterval) clearInterval(countdownInterval);
                    countdownInterval = null;
                }
            });

            await handleAuth();
        }

        initializeAppAndAuth();
        
        // --- Utility Functions ---

        const formatTime = (ms) => {
            if (ms < 0) return "00:00:00";
            const totalSeconds = Math.floor(ms / 1000);
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        };

        const isConsecutiveDay = (date1, date2) => {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            d1.setHours(0, 0, 0, 0);
            d2.setHours(0, 0, 0, 0);
            const diff = d1.getTime() - d2.getTime();
            return diff === 86400000; // Exactly 24 hours difference
        };
        
        const canUserClaimReward = (lastClaimTimestamp) => {
            if (!lastClaimTimestamp) return true;
            const lastClaimTime = lastClaimTimestamp.toDate ? lastClaimTimestamp.toDate().getTime() : lastClaimTimestamp;
            const now = Date.now();
            const timeElapsed = now - lastClaimTime;
            return timeElapsed >= 86400000; // 24 hours lockout (86,400,000 ms)
        };

        // --- Core Countdown Logic ---
        function startCountdown(lastClaimTime) {
            if (countdownInterval) clearInterval(countdownInterval);

            const targetTime = lastClaimTime + 86400000;

            const updateTimer = () => {
                const timeRemaining = targetTime - Date.now();

                if (timeRemaining <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    
                    // Re-run the listener to update the metrics and button text
                    setupHistoryListener(); 
                    return;
                }
                
                NEXT_MINT_COUNTDOWN.textContent = formatTime(timeRemaining);
                
                // Ensure UI is set for countdown mode (Button text changes)
                COUNTDOWN_DISPLAY.classList.remove('hidden');
                SUBMIT_BUTTON.textContent = "Log Frame Shift (Reward Locked)";
                SUBMIT_BUTTON.classList.add('bg-gray-700', 'hover:bg-gray-600', 'text-gray-300');
                SUBMIT_BUTTON.classList.remove('bg-[#79e0ee]', 'text-black', 'hover:bg-[#60b3c4]');
                MESSAGE_BOX.textContent = "Submit to log your shift, but D-PNT is locked until the countdown hits 0.";
                MESSAGE_BOX.className = 'text-center text-yellow-400';
            };

            updateTimer(); // Initial call
            countdownInterval = setInterval(updateTimer, 1000);
        }


        // --- Metric Calculation and Listener ---

        function calculateDepthMetrics(history) {
            let totalDPNT = 0;
            let currentStreak = 0;

            // Only consider entries that successfully claimed a reward for streak calculation
            const claimedEntries = history.filter(entry => entry.rewardClaimed).sort((a, b) => {
                const aTime = a.timestamp.toDate ? a.timestamp.toDate().getTime() : a.timestamp;
                const bTime = b.timestamp.toDate ? b.timestamp.toDate().getTime() : b.timestamp;
                return bTime - aTime;
            });

            if (claimedEntries.length === 0) {
                return { totalDPNT: 0, currentStreak: 0, lastClaimTimestamp: null };
            }

            claimedEntries.forEach(entry => {
                totalDPNT += entry.d_pnt_reward || 1; 
            });

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let latestClaimedDate = claimedEntries[0].timestamp.toDate();
            latestClaimedDate.setHours(0, 0, 0, 0);

            const isToday = latestClaimedDate.getTime() === today.getTime();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            yesterday.setHours(0, 0, 0, 0);
            const isYesterday = latestClaimedDate.getTime() === yesterday.getTime();
            
            if (!isToday && !isYesterday) {
                 return { totalDPNT, currentStreak: 0, lastClaimTimestamp: claimedEntries[0].timestamp };
            }

            currentStreak = isToday ? 1 : 0;
            let lastStreakDate = isToday ? latestClaimedDate : yesterday;
            
            if (isYesterday && claimedEntries.length > 0) {
                currentStreak = 1;
                lastStreakDate = latestClaimedDate;
            }

            for (let i = (isToday ? 1 : 0); i < claimedEntries.length; i++) {
                const currentEntryDate = claimedEntries[i].timestamp.toDate();
                currentEntryDate.setHours(0, 0, 0, 0);

                if (isConsecutiveDay(lastStreakDate, currentEntryDate.getTime())) {
                    currentStreak++;
                    lastStreakDate = currentEntryDate;
                } else {
                    if (lastStreakDate.getTime() !== currentEntryDate.getTime()) {
                        break;
                    }
                    // Handle double claim attempt on same day (shouldn't happen with 24hr lock but for safety)
                }
            }

            return { totalDPNT, currentStreak, lastClaimTimestamp: claimedEntries[0].timestamp };
        }

        function updateMetrics(totalDPNT, currentStreak) {
            DPNT_COUNT.textContent = totalDPNT;
            STREAK_COUNT.textContent = currentStreak;
            
            let progress = 0;
            if (currentStreak > 0) {
                progress = (currentStreak % 7) / 7 * 100;
                if (progress === 0 && currentStreak !== 0) {
                    progress = 100;
                }
            }
            STREAK_BAR.style.width = `${progress}%`;
        }

        function setupHistoryListener() {
            if (!isAuthReady || !userId || !db) return;

            HISTORY_CONTAINER.innerHTML = `<p id="history-loading" class="text-gray-500 text-center">Loading past Frame Shifts...</p>`;
            
            // Clear any active countdown
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = null;
            COUNTDOWN_DISPLAY.classList.add('hidden');

            const historyRef = collection(db, `artifacts/${finalAppId}/users/${userId}/frame_shifts`);
            const q = query(historyRef); 
            
            return onSnapshot(q, (querySnapshot) => {
                const history = [];
                querySnapshot.forEach(doc => {
                    history.push(doc.data());
                });

                // Client-side sorting (Desc: most recent first)
                history.sort((a, b) => {
                    const aTime = a.timestamp.toDate ? a.timestamp.toDate().getTime() : a.timestamp;
                    const bTime = b.timestamp.toDate ? b.timestamp.toDate().getTime() : b.timestamp;
                    return bTime - aTime;
                });

                // 1. Calculate Metrics
                const { totalDPNT, currentStreak, lastClaimTimestamp } = calculateDepthMetrics(history);
                updateMetrics(totalDPNT, currentStreak);

                // --- UI State Management (Button and Timer) ---
                if (history.length === 0) {
                    HISTORY_CONTAINER.innerHTML = `<p class="text-gray-500 text-center py-4">No Frame Shifts logged yet. Start your growth journey!</p>`;
                    // Set default ready state
                    SUBMIT_BUTTON.textContent = "Mint D-PNT and Log Frame Shift";
                    SUBMIT_BUTTON.classList.remove('bg-gray-700', 'hover:bg-gray-600', 'text-gray-300');
                    SUBMIT_BUTTON.classList.add('bg-[#79e0ee]', 'text-black', 'hover:bg-[#60b3c4]');
                    MESSAGE_BOX.textContent = "";
                    COUNTDOWN_DISPLAY.classList.add('hidden');
                    return;
                }

                // 2. Determine Claim Status and Update Form Button
                const canClaim = canUserClaimReward(lastClaimTimestamp);

                if (!canClaim && lastClaimTimestamp) {
                    // Lock active: Start the countdown and set button text to 'Log Shift Only'
                    const lastClaimTime = lastClaimTimestamp.toDate ? lastClaimTimestamp.toDate().getTime() : lastClaimTimestamp;
                    startCountdown(lastClaimTime);

                } else {
                    // Ready to claim: Ensure button and message are set correctly
                    if (countdownInterval) clearInterval(countdownInterval);
                    countdownInterval = null;
                    COUNTDOWN_DISPLAY.classList.add('hidden');
                    
                    SUBMIT_BUTTON.textContent = "Mint D-PNT and Log Frame Shift";
                    SUBMIT_BUTTON.classList.remove('bg-gray-700', 'hover:bg-gray-600', 'text-gray-300');
                    SUBMIT_BUTTON.classList.add('bg-[#79e0ee]', 'text-black', 'hover:bg-[#60b3c4]');
                    MESSAGE_BOX.textContent = "The next D-PNT mint is available now!"; 
                    MESSAGE_BOX.className = 'text-center text-green-400 font-bold';
                }

                // 3. Render History Log
                HISTORY_CONTAINER.innerHTML = '';
                history.forEach(entry => {
                    const date = entry.timestamp.toDate().toLocaleDateString('en-US', { 
                        month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' 
                    });
                    const rewardTag = entry.rewardClaimed 
                        ? `<span class="text-xs bg-green-900 text-green-300 px-2 py-0.5 rounded-full">${entry.d_pnt_reward} D-PNT</span>` 
                        : `<span class="text-xs bg-gray-700 text-gray-400 px-2 py-0.5 rounded-full">Shift Logged (No Reward)</span>`;

                    const item = document.createElement('div');
                    item.className = 'card p-4 rounded-lg shadow-md';
                    item.innerHTML = `
                        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
                            <p class="text-sm font-semibold text-gray-300">${date}</p>
                            ${rewardTag}
                        </div>
                        <p class="text-xs text-gray-500 uppercase">Trigger: <span class="text-gray-200">${entry.trigger}</span></p>
                        <p class="text-xs text-gray-500 uppercase mt-1">Old Frame: <span class="text-gray-200">${entry.oldFrame}</span></p>
                        <p class="text-xs text-gray-500 uppercase mt-1">New Frame: <span class="text-gray-200">${entry.newFrame}</span></p>
                    `;
                    HISTORY_CONTAINER.appendChild(item);
                });

            }, (error) => {
                console.error("Real-time History Listener Error:", error);
                HISTORY_CONTAINER.innerHTML = `<p class="text-red-500 text-center py-4">Error accessing history. Deploy the correct Firebase Security Rules.</p>`;
                SUBMIT_BUTTON.textContent = "ERROR: History Access Denied";
                SUBMIT_BUTTON.classList.add('opacity-50', 'cursor-not-allowed');
            });
        }
        
        // --- Submission Handler (Always allows logging, conditionally rewards D-PNT) ---
        document.getElementById('frame-shift-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId || !db) {
                MESSAGE_BOX.textContent = 'Error: Authentication not ready.';
                MESSAGE_BOX.className = 'mt-4 text-center text-red-400';
                return;
            }

            const originalButtonText = SUBMIT_BUTTON.textContent;
            SUBMIT_BUTTON.disabled = true;
            SUBMIT_BUTTON.textContent = 'Processing...';

            const trigger = document.getElementById('trigger').value.trim();
            const oldFrame = document.getElementById('old-frame').value.trim();
            const newFrame = document.getElementById('new-frame').value.trim();

            if (!trigger || !oldFrame || !newFrame) {
                MESSAGE_BOX.textContent = 'All three fields must be filled.';
                MESSAGE_BOX.className = 'mt-4 text-center text-yellow-400';
                SUBMIT_BUTTON.disabled = false;
                SUBMIT_BUTTON.textContent = originalButtonText; // Restore original text
                return;
            }

            try {
                // Get current data for reward check
                const historyRef = collection(db, `artifacts/${finalAppId}/users/${userId}/frame_shifts`);
                const querySnapshot = await getDocs(query(historyRef)); 

                let historyData = querySnapshot.docs.map(doc => doc.data());
                
                // Client-side sorting for reward check
                historyData.sort((a, b) => {
                    const aTime = a.timestamp.toDate ? a.timestamp.toDate().getTime() : a.timestamp;
                    const bTime = b.timestamp.toDate ? b.timestamp.toDate().getTime() : b.timestamp;
                    return bTime - aTime; 
                });

                const latestClaimedEntry = historyData.find(entry => entry.rewardClaimed);

                const canClaim = canUserClaimReward(latestClaimedEntry?.timestamp);
                let rewardClaimed = false;
                let dpntReward = 0;

                if (canClaim) {
                    // Check streak based on existing claimed entries (before adding the new one)
                    const { currentStreak } = calculateDepthMetrics(historyData); 
                    rewardClaimed = true;
                    dpntReward = 1;
                    
                    if ((currentStreak + 1) % 7 === 0) {
                        dpntReward = 2; // Bonus reward
                    }
                }

                const timestamp = new Date();
                const docId = timestamp.getTime().toString() + Math.floor(Math.random() * 1000).toString();
                
                const newEntry = {
                    trigger,
                    oldFrame,
                    newFrame,
                    timestamp,
                    rewardClaimed,
                    d_pnt_reward: dpntReward,
                    userId
                };

                const docRef = doc(db, `artifacts/${finalAppId}/users/${userId}/frame_shifts`, docId);
                await setDoc(docRef, newEntry);
                
                // Clear form fields
                document.getElementById('trigger').value = '';
                document.getElementById('old-frame').value = '';
                document.getElementById('new-frame').value = '';

                let successMessage;
                if (rewardClaimed) {
                    successMessage = `Shift Logged & Reward Claimed! Minted ${dpntReward} D-PNT.`;
                    MESSAGE_BOX.className = 'text-center text-green-400 font-bold';
                } else {
                    successMessage = "Shift Logged to History! No D-PNT minted (lock active).";
                    MESSAGE_BOX.className = 'text-center text-yellow-400';
                }
                
                MESSAGE_BOX.textContent = successMessage;
                // The onSnapshot listener will handle the final button state and timer update
                SUBMIT_BUTTON.disabled = false;

            } catch (error) {
                MESSAGE_BOX.textContent = 'An error occurred during submission: ' + error.message;
                MESSAGE_BOX.className = 'text-center text-red-400';
                console.error("Submission Error:", error);
                SUBMIT_BUTTON.disabled = false;
                SUBMIT_BUTTON.textContent = originalButtonText; // Restore original text
            }
        });

    </script>
</body>
</html>

